<html>
    <head>

    </head>
    <body>
        <canvas id="c" width="600" height="600"></canvas>
    </body>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
          }
        }
    </script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="module">
        import * as THREE from 'three'
        import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';


        const canvas = document.getElementById("c")

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);

        camera.position.z = 2

        const renderer = new THREE.WebGLRenderer({
            canvas,
            alpha: true,
            antialias:true
        });

        const bigCubeGeo = new THREE.BoxGeometry(1, 1, 1)
        const bigCubeMat = new THREE.MeshBasicMaterial({
            color: 0xFF00FF
        })

        const bigCube = new THREE.Mesh(bigCubeGeo, bigCubeMat)
        scene.add(bigCube)
        bigCube.position.z += 2

        const gltfLoader = new GLTFLoader();
        const url = 'models/dash.glb';
        gltfLoader.load(url, (gltf) => {
            const root = gltf.scene;
            scene.add(root);
        })

        const light = new THREE.AmbientLight(0xFFFFFF, 1);
        scene.add(light);   

        const raycaster = new THREE.Raycaster()
        let pickPosition = {x:0, y:0}

        camera.position.z += 10

        let vx = 0 
        let vz = 0

        let pos = {x: -10000, y:-10000}

        let oldObject
        let oldObjectColor

        function render(){
            camera.position.x += vx
            camera.position.z += vz

            raycaster.setFromCamera({x: pos.x, y:pos.y}, camera);
            const intersectedObjects = raycaster.intersectObjects(scene.children);
            if(oldObject){
                oldObject.object.material.color = oldObjectColor
                oldObject = undefined
            }
            if (intersectedObjects.length) {
                oldObject = {...intersectedObjects[0]}
                oldObjectColor ={...intersectedObjects[0].object.material.color}
                intersectedObjects[0].object.material.color = new THREE.Color(0x00FFFF);
            }

            renderer.render(scene, camera)
            requestAnimationFrame(render)
        }
        requestAnimationFrame(render)

        renderer.render(scene, camera)


        document.addEventListener("keydown", (event) => {
            if(event.keyCode == 37){
                vx = -0.1
            } else if(event.keyCode == 39){
                vx = 0.1
            } else if(event.keyCode == 38){
                vz = -0.1
            } else if(event.keyCode == 40){
                vz = 0.1
            }

            renderer.render(scene, camera)
        })
        document.addEventListener("keyup", () => {
            vx = 0
            vz = 0
        })
        
        function setPos(event){
            const rect = canvas.getBoundingClientRect();
            pos = {
                x: ((event.clientX - rect.left) / rect.width) * 2 - 1,
                y: ((event.clientY - rect.top) / rect.height) * -2 + 1
            }
        }

        function clearPos(){
            pos = {
                x: -10000,
                y: -10000
            }
        }

        window.addEventListener('mousemove', setPos);
        window.addEventListener('mouseout', clearPos);
        window.addEventListener('mouseleave', clearPos);
        
        window.addEventListener("click", (event) => {
            const rect = canvas.getBoundingClientRect();
            raycaster.setFromCamera({
                x: ((event.clientX - rect.left) / rect.width) * 2 - 1,
                y: ((event.clientY - rect.top) / rect.height) * -2 + 1
            }, camera);
            const intersectedObjects = raycaster.intersectObjects(scene.children);
            if(oldObject){
                oldObject.object.material.color = oldObjectColor
                oldObject = undefined
            }
            if (intersectedObjects.length) {
                let object = intersectedObjects[0].object
                oldObject = {...intersectedObjects[0]}
                oldObjectColor ={...intersectedObjects[0].object.material.color}
                // const color = new THREE.Color("hsl(0, 100%, 50%)");
                // intersectedObjects[0].object.material.color = {isColor: true, r:0, g:1, b:0}
                // intersectedObjects[0].object.material.color = color
                // console.log(intersectedObjects[0].object.id)

                if(object.id == 10){
                    alert("Click!")
                }

                // alert("You Clicked Me!")
            }
        })
    </script>
</html>