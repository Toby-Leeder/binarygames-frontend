<html>
    <head>

    </head>
    <body>
        <div id="container">
            <canvas id="c" width="600" height="600"></canvas>
            <img id="overlay">
            <div id="popUp"></div>
        </div>
    </body>
    <style>
        #container{
            position:relative;
        }
        #c, #overlay #popUp {
            position: absolute;
        }
    </style>
    <script>
        const canvas = document.getElementById("c")
        const overlay = document.getElementById("overlay")
        var left = canvas.width/2 - canvas.width/50
        overlay.style.top = `${canvas.height/2}px`
        overlay.style.left = `${left}px`;
        overlay.src = "../images/cursor.png";
        overlay.style.maxWidth = `${canvas.height/20}px`

        function makeOverlay(){
            var popUp = document.getElementById("popUp")
            popUp.style.maxWidth = "200px"
            popUp.style.backgroundColor = "red"
            popUp.style.maxWidth = "200px"
            console.log("running")
        }
    </script>
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
          }
        }
    </script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="module">
        import * as THREE from 'three'
        import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
        // import { PointerLockControls } from '../assets/js/PointerControls.js';
        import { PointerLockControls } from './assets/js/PointerControls.js';


        var roomLength = 20
        var roomHeight = 5.5

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);

        camera.position.z = 2

        const renderer = new THREE.WebGLRenderer({
            canvas,
            alpha: true,
            antialias:true
        });

        const bigCubeGeo = new THREE.BoxGeometry(1, 1, 1)
        const bigCubeMat = new THREE.MeshBasicMaterial({
            color: 0xFF00FF
        })

        const bigCube = new THREE.Mesh(bigCubeGeo, bigCubeMat)
        scene.add(bigCube)
        bigCube.position.z += 2

        const gltfLoader = new GLTFLoader();
        const url = 'models/dash.glb';
        gltfLoader.load(url, (gltf) => {
            const root = gltf.scene;
            scene.add(root);
        })

        const light = new THREE.AmbientLight(0xFFFFFF, 1);
        scene.add(light);   

        const raycaster = new THREE.Raycaster()
        let pickPosition = {x:0, y:0}

        const controls = new PointerLockControls( camera, document.body );
        controls.connect();

        makeRoom();

        camera.position.z += 10

        let vx = 0 
        let vz = 0

        let pos = {x: -10000, y:-10000}

        let oldObject
        let oldObjectColor
        let oldObject2
        let oldObjectColor2

        function render(){
            camera.position.x += vx
            camera.position.z += vz

            raycaster.setFromCamera({x: 0, y:0}, camera);
            const intersectedObjects = raycaster.intersectObjects(scene.children);
            if(oldObject){
                oldObject.object.material.color = oldObjectColor
                oldObject = undefined
            }
            if (intersectedObjects.length) {
                oldObject = {...intersectedObjects[0]}
                oldObjectColor ={...intersectedObjects[0].object.material.color}
                intersectedObjects[0].object.material.color = new THREE.Color(0x00FFFF);
            }


            move();

            renderer.render(scene, camera)
            requestAnimationFrame(render)
        }
        requestAnimationFrame(render)

        renderer.render(scene, camera)


        document.addEventListener("keydown", (event) => {
            if(event.keyCode == 37){
                vx = -0.1
            } else if(event.keyCode == 39){
                vx = 0.1
            } else if(event.keyCode == 38){
                vz = -0.1
            } else if(event.keyCode == 40){
                vz = 0.1
            }

            renderer.render(scene, camera)
        })
        document.addEventListener("keyup", () => {
            vx = 0
            vz = 0
        })
        
        function setPos(event){
            const rect = canvas.getBoundingClientRect();
            pos = {
                x: ((event.clientX - rect.left) / rect.width) * 2 - 1,
                y: ((event.clientY - rect.top) / rect.height) * -2 + 1
            }
        }

        function clearPos(){
            pos = {
                x: -10000,
                y: -10000
            }
        }

        // window.addEventListener('mousemove', setPos);
        // window.addEventListener('mouseout', clearPos);
        // window.addEventListener('mouseleave', clearPos);
        
        window.addEventListener("click", (event) => {
            const rect = canvas.getBoundingClientRect();
            console.log(scene)


            // raycaster.setFromCamera({
            //     x: ((event.clientX - rect.left) / rect.width) * 2 - 1,
            //     y: ((event.clientY - rect.top) / rect.height) * -2 + 1
            // }, camera);            
            raycaster.setFromCamera({
                x: 0,
                y: 0
            }, camera);
            const intersectedObjects = raycaster.intersectObjects(scene.children);
            if(oldObject){
                oldObject.object.material.color = oldObjectColor
                oldObject = undefined
            }
            if (intersectedObjects.length) {
                let object = intersectedObjects[0].object
                oldObject = {...intersectedObjects[0]}
                oldObjectColor ={...intersectedObjects[0].object.material.color}
                const color = new THREE.Color("hsl(0, 100%, 50%)");
                intersectedObjects[0].object.material.color = {isColor: true, r:0, g:1, b:0}
                intersectedObjects[0].object.material.color = color
                console.log(intersectedObjects[0].object.id)
                console.log(intersectedObjects[0])

                if(object.id == 10 && controls.isLocked){
                    controls.unlock()
                    makeOverlay()
                }

                console.log("You Clicked Me!")
            }
        })

        var forward = false;
        var back = false;
        var left = false;
        var right = false;
        var unlocked = true;
        document.addEventListener("keydown", (event) => {
            switch (event.code) {
                case 'KeyW':
                    forward = true
                    break
                case 'KeyA':
                    left = true
                    break
                case 'KeyS':
                    back = true
                    break
                case 'KeyD':
                    right = true
                    break
            }
        });

        document.addEventListener("keyup", (event) => {
            switch (event.code) {
                case 'KeyW':
                    forward = false
                    break
                case 'KeyA':
                    left = false
                    break
                case 'KeyS':
                    back = false
                    break
                case 'KeyD':
                    right = false
                    break
            }
        })

        canvas.addEventListener("click", (event) => {
            if (!controls.isLocked){
                controls.lock();
            }
            else {
            }
        });

        function move(){
            if (forward){
                controls.moveForward(0.1);
            }
            if (back){
                controls.moveBackward(0.1);
            }
            if (right){
                controls.moveRight(0.1);
            }
            if (left){
                controls.moveLeft(0.1);
            }
            
        }

        function makeRoom(){
            var length = roomLength
            var height = roomHeight

            const geometry = new THREE.BoxGeometry( length, 15, 0.4 ); 
            const material = new THREE.MeshBasicMaterial( {color: 0x00ff00} );
            
            const wall1 = new THREE.Mesh( geometry, material ); 
            wall1.position.y = height;
            scene.add( wall1 );

            const wall2 = new THREE.Mesh( geometry, material ); 
            wall2.position.y = height;
            wall2.position.x = length/2;
            wall2.position.z = length/2;
            wall2.rotation.y = Math.PI/2
            scene.add( wall2 );

            const wall3 = new THREE.Mesh( geometry, material ); 
            wall3.position.y = height;
            wall3.position.x = -length/2;
            wall3.position.z = length/2;
            wall3.rotation.y = Math.PI/2
            scene.add( wall3 );

            const wall4 = new THREE.Mesh( geometry, material ); 
            wall4.position.y = height;
            wall4.position.z = length
            scene.add( wall4 );
        }
    </script>
</html>